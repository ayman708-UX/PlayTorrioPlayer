name: build

on:
  push:
    branches: ["*"]
    pull_request:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  linux:
    runs-on: ubuntu-22.04
    name: Ubuntu
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install dependencies
        run: |
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build git pkg-config \
          libfuse2 libgtk-3-dev libglfw3-dev libfreetype6-dev libmpv-dev
      - name: Build PlayTorrioPlayer
        env:
          DEPLOY_GTK_VERSION: 3
        run: |
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=RELEASE -DCMAKE_INSTALL_PREFIX:PATH=/usr -DCREATE_PACKAGE=ON -G Ninja ..
          cmake --build . --target package
          cmake --install . --prefix AppDir/usr
          curl -LO https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          curl -LO https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh
          chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-gtk.sh
          ./linuxdeploy-x86_64.AppImage --appdir $(pwd)/AppDir --plugin gtk --output appimage
          # Rename outputs to PlayTorrioPlayer
          for f in PlayTorrioPlayer-*.deb; do mv "$f" "${f/PlayTorrioPlayer-/PlayTorrioPlayer-linux-}"; done 2>/dev/null || true
          for f in PlayTorrioPlayer-*.AppImage; do mv "$f" "${f/PlayTorrioPlayer-/PlayTorrioPlayer-linux-}"; done 2>/dev/null || true
      - uses: actions/upload-artifact@v4
        with:
          name: PlayTorrioPlayer-linux
          path: |
            build/PlayTorrioPlayer-*.AppImage
            build/PlayTorrioPlayer-*.deb
  macos:
    runs-on: macos-14
    name: macOS
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install dependencies
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1
        run: |
          brew install cmake ninja git mpv freetype2 pkg-config dylibbundler create-dmg
      - name: Build PlayTorrioPlayer
        env:
          PKG_CONFIG_PATH: /opt/homebrew/opt/libarchive/lib/pkgconfig:/usr/local/opt/libarchive/lib/pkgconfig
        run: |
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=RELEASE -DUSE_PATCHED_GLFW=ON -G Ninja ..
          cmake --build .
      - name: Create App Bundle
        run: |
          cd build
          VERSION=$(git describe --tags --always)
          
          # Create app bundle structure
          mkdir -p PlayTorrioPlayer.app/Contents/MacOS
          mkdir -p PlayTorrioPlayer.app/Contents/Frameworks
          mkdir -p PlayTorrioPlayer.app/Contents/Resources
          
          # Copy executable
          cp PlayTorrioPlayer PlayTorrioPlayer.app/Contents/MacOS/
          
          # Copy icon
          cp ../resources/macos/AppIcon.icns PlayTorrioPlayer.app/Contents/Resources/ 2>/dev/null || true
          
          # Create Info.plist
          cat > PlayTorrioPlayer.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>PlayTorrioPlayer</string>
            <key>CFBundleIconFile</key>
            <string>AppIcon</string>
            <key>CFBundleIdentifier</key>
            <string>com.playtorrioplayer.app</string>
            <key>CFBundleName</key>
            <string>PlayTorrioPlayer</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>${VERSION}</string>
            <key>CFBundleVersion</key>
            <string>${VERSION}</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>LSMinimumSystemVersion</key>
            <string>11.0</string>
          </dict>
          </plist>
          EOF
          
          # Use dylibbundler to bundle all dylib dependencies
          # This handles all transitive dependencies including libjxl_cms
          dylibbundler -od -b -x ./PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer \
            -d ./PlayTorrioPlayer.app/Contents/Frameworks/ \
            -p @executable_path/../Frameworks/ \
            -s /opt/homebrew/lib \
            -s /usr/local/lib
          
          # Ad-hoc code sign the app
          codesign --force --deep --sign - PlayTorrioPlayer.app
      - name: Create DMG
        run: |
          cd build
          VERSION=$(git describe --tags --always)
          
          # Create DMG using create-dmg
          create-dmg \
            --volname "PlayTorrioPlayer" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 450 185 \
            "PlayTorrioPlayer-macOS-${VERSION}.dmg" \
            "PlayTorrioPlayer.app" || true
          
          # Fallback: create zip if DMG creation fails
          if [ ! -f PlayTorrioPlayer-*.dmg ]; then
            zip -r "PlayTorrioPlayer-macOS-${VERSION}.zip" PlayTorrioPlayer.app
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: PlayTorrioPlayer-macOS
          path: |
            build/PlayTorrioPlayer-*.dmg
            build/PlayTorrioPlayer-*.zip
  win:
    runs-on: windows-latest
    name: Windows
    steps:
      - name: Prepare git
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          install: >-
            base-devel
            git
            p7zip
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-freetype
          update: true
      - name: Build PlayTorrioPlayer
        shell: msys2 {0}
        run: |
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=RELEASE -DUSE_PATCHED_GLFW=ON -DUSE_OPENGL_ES3=ON -DCREATE_PACKAGE=ON -G Ninja ..
          cmake --build . --target package
          # Rename outputs to PlayTorrioPlayer
          for f in PlayTorrioPlayer-*.msi; do mv "$f" "${f/PlayTorrioPlayer-/PlayTorrioPlayer-win64-}" 2>/dev/null; done || true
          for f in PlayTorrioPlayer-*.zip; do mv "$f" "${f/PlayTorrioPlayer-/PlayTorrioPlayer-win64-}" 2>/dev/null; done || true
      - uses: actions/upload-artifact@v4
        with:
          name: PlayTorrioPlayer-win64
          path: |
            build/PlayTorrioPlayer-*.msi
            build/PlayTorrioPlayer-*.zip
  publish:
    needs: [linux, macos, win]
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
      - name: List artifacts
        run: find . -name "PlayTorrioPlayer-*" -type f
      - uses: ncipollo/release-action@v1
        with:
          commit: ${{ github.sha }}
          tag: continuous
          artifacts: "PlayTorrioPlayer-*/*"
          allowUpdates: true
          prerelease: true
          name: Continuous build
          body: |
            > WARNING: This is the DEV version, may contains bugs or unfinished features.
            # Install
            ## Windows
            - MSI
              - Download the msi executable
              - Run the MSI installer
              - Run PlayTorrioPlayer from Start Menu
            - Zip
              - Download the windows zip
              - Extract the zip
              - Run `PlayTorrioPlayer.exe`
            ## macOS
            - Download the dmg file
            - Double click the dmg to show it's contents
            - Drag PlayTorrioPlayer to `Applications` folder
            - Run PlayTorrioPlayer from Launchpad
            ## Linux
            - Debian Package
              - Download the deb file
              - Install: `sudo apt install ./PlayTorrioPlayer-*.deb`
              - Run `PlayTorrioPlayer`
            - AppImage
              - Download the AppImage file
              - Run `chmod u+x PlayTorrioPlayer-*.AppImage && ./PlayTorrioPlayer-*.AppImage`

